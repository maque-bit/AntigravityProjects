---
import Layout from '../layouts/Layout.astro';
import ProjectCard from '../components/ProjectCard.astro';
import fs from 'node:fs/promises';
import path from 'node:path';

// Data Fetching Logic (Server-side)
// Running in dev mode, process.cwd() is src/web but we need data from monorepo root
// In deployment, we assume data is available or copied.
// For now, let's try reading from relative path which works in standard node setup
let data = { projects: [] };
try {
    // Attempt to resolve path relative to this file
    // fileURLToPath(import.meta.url) gives absolute path of this file.
    // We go up 4 levels to data/
    const dataPath = path.resolve('./src/data/analyzed_data.json'); 
    // CWD may vary, let's try resolving relative to project root if possible, or just standard relative path
    // If CWD is src/web, then ../data is src/data.
    const relativePath = path.resolve('../data/analyzed_data.json');
    // Or just '../data/analyzed_data.json' if fs takes relative from CWD.
    // path.resolve creates absolute path.
    const content = await fs.readFile(relativePath, 'utf-8');
    data = JSON.parse(content);
} catch (e) {
    console.error("Failed to load data:", e);
    // Fallback Mock Data for preview if file missing
}

const projects = data.projects || [];
const lastUpdated = data.last_updated ? new Date(data.last_updated).toLocaleString('ja-JP') : "Unknown";
---

<Layout title="MCP Insider | Discover the Best Servers">
    <main class="container mx-auto px-4 py-8 md:py-16 max-w-7xl">
        <header class="text-center mb-16 relative">
            <div class="inline-block mb-4 px-3 py-1 bg-indigo-900/30 border border-indigo-700/50 rounded-full text-indigo-300 text-xs font-mono tracking-wider">
                LAST UPDATED: {lastUpdated}
            </div>
            <h1 class="text-5xl md:text-7xl font-black tracking-tighter mb-6 bg-clip-text text-transparent bg-gradient-to-b from-white via-indigo-100 to-indigo-900/50">
                MCP INSIDER
            </h1>
            <p class="text-slate-400 text-lg md:text-xl max-w-2xl mx-auto leading-relaxed">
                厳選された <span class="text-indigo-400 font-bold">Model Context Protocol</span> サーバーを、
                エンジニア視点で深掘り分析。開発効率を爆上げするツールを見つけよう。
            </p>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {projects.map((project) => (
                <ProjectCard project={project} />
            ))}
        </section>
        
        {projects.length === 0 && (
            <div class="text-center py-20 text-slate-500">
                <p>No projects found. Check the data collector status.</p>
            </div>
        )}
    </main>
</Layout>
