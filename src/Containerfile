# 共通ベースイメージ
FROM node:20-alpine AS base
WORKDIR /app
RUN apk add --no-cache sqlite bash

# --- Admin サービス ---
FROM base AS admin-dev
COPY admin/package*.json ./admin/
RUN npm install --prefix admin
COPY admin/ ./admin
EXPOSE 3000

FROM base AS admin-prod
COPY admin/package*.json ./admin/
RUN npm ci --prefix admin --only=production
COPY admin/ ./admin
EXPOSE 3000

# --- Collector サービス ---
FROM base AS collector-dev
COPY collector/package*.json ./collector/
RUN npm install --prefix collector
COPY collector/ ./collector

FROM base AS collector-prod
COPY collector/package*.json ./collector/
RUN npm ci --prefix collector --only=production
COPY collector/ ./collector

# --- Analyzer サービス ---
FROM base AS analyzer-dev
COPY analyzer/package*.json ./analyzer/
RUN npm install --prefix analyzer
COPY analyzer/ ./analyzer

FROM base AS analyzer-prod
COPY analyzer/package*.json ./analyzer/
RUN npm ci --prefix analyzer --only=production
COPY analyzer/ ./analyzer

# --- Web サービス ---
FROM base AS web-dev
COPY web/package*.json ./web/
RUN npm install --prefix web
COPY web/ ./web
EXPOSE 4321

FROM base AS web-prod
COPY web/package*.json ./web/
RUN npm ci --prefix web --only=production
COPY web/ ./web
EXPOSE 4321

# デフォルト（互換性のため）
FROM base AS development
